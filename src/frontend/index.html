<!DOCTYPE html>
<html>
<head lang="en-US">
	<title>AnimeShooter</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="description" content="Server Emulator for QPang aka MangaFigher." />
	<meta name="keywords" content="Server emulator, Multiplayer, FPS, Shooter, anime, cartoon" />
	<link href="https://fonts.googleapis.com/css2?family=Zen+Dots&display=swap" rel="stylesheet">
	<link href="css/style.css" type="text/css" rel="stylesheet"/>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Fira+Sans" rel="stylesheet">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta property="og:title" content="AnimeShooter!" />
	<meta property="og:type" content="profile" />
	<meta property="og:description" content="Server Emulator for QPang aka MangaFighter." />
	<meta property="og:url" content="https://animeshooter.com/" />
	<meta property="og:image" content="/img/ken.png" />
	<meta property="og:image:type" content="image/png" />
	<meta property="og:image:width" content="600" />
	<meta property="og:image:height" content="600" />
	<meta property="og:image:alt" content="Ken with a bat" />
</head>
<body>
	<div class="page-main">
		<div class="page-header">	
			<img src="img/ken.png" width="152px" height="180px" style="float:left"/>
			<nav class="page-navbar">
				<ul>
					<li><span class="nav-item" onclick="selectPage('Home')">Home</span></li>
					<li><span class="nav-item" onclick="selectPage('Online')">Online</span></li>
					<li><span class="nav-item" onclick="selectPage('Howto')">Download</span></li>
					<!-- <li><span class="nav-item" onclick="selectPage('Help')">Help</span></li> -->
					<li><span class="nav-item" onclick="selectPage('Account')">Account</span></li>
				</ul>
			</nav>
			<div class="page-console">
				
			</div>
		</div>
		<div class="page-contents">
			<!-- Home -->
			<div class="page" id="Home" style="display: block">
				<h1>Welcome to AnimeShooter!<span class="article-note"><span class="wsstatus dot-red">●</span> GameServer</span></h1>
				<div class="carousel">
					<div class="carousel-item">
						<img src="img/test.jpg" />
					</div>
				</div>
				<p>
					AnimeShooter is a private server based on QPang aka <a href="https://en.wikipedia.org/wiki/Manga_Fighter">MangaFigther</a>, the game was a multiplayer online third-person shooter developed by OnNet and hosted by game portal GamesCampus. Players will join other combatants in a 3D manga-style world, with multiple modes of combat and a variety of character customization options. The game first began its open beta on July 31, 2007, and was released to the public on December 3, 2007. The game was shut down on July 30, 2010.
				</p>
				<p>
					AnimeShooter aims to re-create the original experience of the game by providing game servers that follow the exact protocol of the original game. This allows you to use the original game files <i>(and our patcher)</i> to connect to our game servers and play the game like it was 2013!
				</p>
				<p>
					Hopefully, you are just as excited as we are to enjoy the game once again after roughly 8 years since the original game was discontinued!
				</p>
				<h2>Register</h2>
				<p>
					To get started, you must create an account at our website. Once created, you will be guided with instructions to download and install the game and how you can connect to our game servers.
				</p>
				<p>
					Please keep in mind that we are providing our very own game servers that come with their very own database. This means all progress from the original game is NOT there. To obtain in-game items you can use in-game currencies or real-life currencies to purchase in-game goods.
				</p>
				<h2>Community</h2>
				<p>
					We hope you will have a good time fighting against or with online players, we will soon provide a Discord server where you can hang around and meet new people.
				</p>
			</div>
			<!-- Online -->
			<div class="page" id="Online" style="display: none">
				<h1>Live Server Statistics<span class="article-note"><span class="wsstatus dot-red">●</span> GameServer</span></h1>
				<p>
					Total of <span id="gs-playerscount">0</span> Players in <span id="gs-roomcount">0</span> Game Rooms!
				</p>
				<hr/>
				<div id="d2rga-online" class="room-row">
					<div class="room-col-2">
						<div class="room-col">
							<div class="room-item" style="background-image: url('img/maps/small/dollhouse.png');"></div>
							<span class="room-title">#1 - Vet, cool en fun!</span>
							<div class="room-description">Team Death Math</div>
							<span class="room-footer">5/8</span>
						</div>
					</div>
					<div class="room-col-2">
						<div class="room-col">
							<div class="room-item" style="background-image: url('img/maps/small/city.png');"></div>
							<span class="room-title">#2 - Kim kAm qPong?</span>
							<div class="room-description">Essence</div>
							<span class="room-footer">4/4</span>
						</div>
					</div>
					<div class="room-col-2">
						<div class="room-col">
							<div class="room-item" style="background-image: url('img/maps/small/bunker.png');"></div>
							<span class="room-title">#3 - Vet, cool en fun!</span>
							<div class="room-description">Essence</div>
							<span class="room-footer">1/16</span>
						</div>
					</div>
				</div>
			</div>
			<!-- How To (Connect) -->
			<div class="page" id="Howto" style="display: none">
				<h1>How to Connect<span class="article-note"><span class="wsstatus dot-red">●</span> GameServer</span></h1>
				<p>
				Before you can play the game you must first of all DOWNLOAD the game files togheter with our custom patcher.
				</p>
				<p>
				More information on gamefiles + patcher will be provided soonTM
				</p>
			</div>
			<!-- Account -->
			<div class="page" id="Account" style="display: none">
				<h1>Account<span class="article-note"><span class="wsstatus dot-red">●</span> GameServer</span></h1>
				<p>
					Your are not logged in!
				</p>	
			</div>
		</div>
		<div class="page-footer">
			Qpang and MangaFighter are not owned by me. This project is not affiliated with OnNet or GamesCampus in any way.
		</div>
	</div>
</body>

<!-- This is where the magic happens! -->
<script>
/* Page */
function selectPage(name)
{
    var pages = document.getElementsByClassName("page")
    for(var i = 0; i < pages.length; i++)
        pages[i].style.display = "none" // hide others
    document.getElementById(name).style.display = "block";
}

function updateOnlineStatus(online)
{
	var dots = document.getElementsByClassName("wsstatus")
	for(var i = 0; i < dots.length; i++)
	{
		if(online)
			dots[i].classList.replace("dot-red","dot-green");
		else
			dots[i].classList.replace("dot-green","dot-red");
	}
}


/* Websocket (TODO: move to wsserver.js) */
let wsserver = function (URI) {

	var ServerURI = URI;
	var wSocket;
	var lastConnect = 0;

	//let pageConsole = document.getElementByClass("page-console")[0]; // TODO pass as arg

	// Client OpCodes
	let CMSG_AUTH = 0
	let CMSG_HANDSHAKE = 1
	let CMSG_KEYEXCHANGE = 2
	let CMSG_LOGIN = 3
	let CMSG_REGISTER = 4
	let CMSG_STATS = 5
	let CMSG_PING = 6
	
	// Server Opcodes
	let SMSG_PONG = 0
	let SMSG_STATS_RSP = 5
	
	var index;
	var buffer;
	var startTime = 0;	
	
	// Callback handlers
	var _connectCallback;
	var _loginCallback;
	var _statsCallback;
	var _disconnectCallback;
	
	
	_start = function() {
		// auto connect/ping on interval
		_connect();
		setInterval(function() {
			if(wSocket)
			{
				if(_isConnected() && lastConnect + 15000 < _getTicks())
				{
					lastConnect = _getTicks();
					_ping();
					
				}
			}
			else if(lastConnect + 10000 <  _getTicks())
			{
				lastConnect = _getTicks()
				_connect();
			}
		}, 5000)
	}
	
	_connect = function() {
		console.log("Trying to connect...");
		wSocket = new WebSocket(ServerURI);
		wSocket.binaryType = "arraybuffer";
		wSocket.onopen = _connectRsp;
		wSocket.onmessage = _onData;
		wSocket.onclose = _disconnect;
		wSocket.onerror = _disconnect;
	}
	
	_connectRsp = function() {
		// TODO: set user connectd & store login
		_connectCallback();
	}
	
	_disconnect = function(){
		wSocket = null;
		_disconnectCallback();
	}
	
	_onData = function(e) {
		var enc = new TextEncoder(); // TODO: fix text serverside
		var buffer = enc.encode(e.data)
		var opcode = buffer[1];
		switch (opcode) 
		{
			case SMSG_PONG: 
				_pong(buffer); 
				break;
			case SMSG_STATS_RSP:
				_statsRsp(e.data);
				break;
			default:
				console.log("UnkOpcode '" + opcode + "'");
		}
	}

	_login = function(user, pw) {
		let index = 1;
		var len = user.length + pw.length + 3;
		buffer = new Uint8Array(new ArrayBuffer(len));
		buffer[0] = CMSG_LOGIN
		index += _writeString(buffer, index, user)
		index += _writeString(buffer, index, pw)
		wSocket.send(buffer)
		console.log("done");
	}
	
	_loginRsp = function(buffer) {
		// TODO
		_loginCallbback("test")
	}
	
	_stats = function(index) {
		// TODO
	}
	
	_statsRsp = function(buffer) {
		_statsCallback(buffer)
	}
	
	_stats = function(index) {
		// TODO
	}
	
	_ping = function(index) {
		console.log("ping");
		buffer = new Uint8Array(new ArrayBuffer(1));
		buffer[0] = CMSG_PING
		wSocket.send(buffer);
	}
	
	_pong = function(buffer) {
		// TODO
		console.log("pong")
	}
	
	_isConnected = function() {
		return wSocket && wSocket.readyState == WebSocket.OPEN; 
	}
	
	// Private
	_writeString = function(ab, offset, str)  {
		var bytes = new Uint8Array(ab, offset)
		for (var i = 0; i < str.length; i++)
			bytes[i] = str.charCodeAt(i);
		bytes[str.length] = 0
		return str.length + 1
	}
	
	_getTicks = function() {
		return ((new Date()).getTime()) - startTime;
	}
	
	return {
		start: _start,
		login: _login,
		loginRsp: _loginRsp,
		
		onLogin: _loginCallback,
		onConnect: function(f){ _connectCallback = f },
		onLogin: function(f){ _loginCallback = f },
		onStats: function(f){ _statsCallback = f },
		onDisconnect: function(f){ _disconnectCallback = f },
		connected: _isConnected
	}
};

//let wss = new wsserver("ws://localhost:1895");
let wss = new wsserver("ws://d2rga.net:1895");
wss.onConnect(function() {
	console.log("Connected!")
	updateOnlineStatus(wss.connected())
});
wss.onDisconnect(function() {
	console.log("Disconnected!")
	updateOnlineStatus(wss.connected())
});
wss.onStats(function(rawStats) {
	console.log("Stats obtained!")
	var list = document.getElementById("d2rga-online");
	var counter = document.getElementById("d2rga-playerscount");
	var players = rawStats.split(';')
	list.innerHTML = "";
	counter.innerText = players.length-1;
	for(var i = 1; i < players.length; i++)
	{
		var litem = document.createElement('div');
		litem.classList += "online-col";
		var pinfo = players[i].split(':')
		var data = "[" + pinfo[3] + "]: Lvl " + pinfo[1] + " " + pinfo[2];
		var limg = document.createElement('div');
		limg.classList += "online-pic";
		litem.appendChild(limg);
		lspan = document.createElement('span');
		lspan.classList += "online-text";
		lspan.appendChild(document.createTextNode(data))
		litem.appendChild(limg)
		litem.appendChild(lspan)
		list.appendChild(litem)
	}
});
wss.start();
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-9KV3VX3NXF"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-9KV3VX3NXF');
</script>
</html>